{
  "extract_id": "extract_fda34e8905c74485b5508136a3523c3a",
  "results": [
    {
      "url": "https://medium.com/snowflake/granular-cost-attribution-and-chargeback-for-warehouse-costs-on-snowflake-cf96fb690967",
      "title": "Granular cost attribution and chargeback for warehouse costs on Snowflake | by Kaushal Jain | Snowflake Builders Blog: Data Engineers, App Developers, AI, & Data Science | Medium",
      "publish_date": "2024-09-03",
      "excerpts": [
        "Sitemap\n\n[Open in app](https://play.google.com/store/apps/details?id=com.medium.reader&referrer=utm_source%3DmobileNavBar&source=post_page---top_nav_layout_nav-----------------------------------------)\n\nWrite\n\nSearch\n\n[## Snowflake Builders Blog: Data Engineers, App Developers, AI, & Data Science](https://medium.com/snowflake?source=post_page---publication_nav-34b6daafc07-cf96fb690967---------------------------------------)\n\n\u00b7\n\n[](https://medium.com/snowflake?source=post_page---post_publication_sidebar-34b6daafc07-cf96fb690967---------------------------------------)\n\nBest practices, tips & tricks from Snowflake experts and community\n\n# Granular cost attribution and chargeback for warehouse costs on Snowflake\n\nKaushal Jain\n\n6 min read\n\n\u00b7\n\nSep 3, 2024\n\n\\--\n\nListen\n\nShare\n\nPress enter or click to view image in full size\n\nImagine a Snowflake warehouse as a virtual processing facility. While Snowflake has a separate storage layer for data, the virtual [warehouse](https://docs.snowflake.com/en/user-guide/warehouses) is primarily responsible for the compute tasks. The size and activity level of the warehouse determine the costs, similar to how a busier processing facility would incur higher expenses.\n\nA common request by Snowflake customers is how to attribute costs to individual queries at a finer grain than a whole warehouse. This blog post will explore various methods to allocate compute costs and introduce the [per query cost attribution](https://docs.snowflake.com/LIMITEDACCESS/query_attribution_history) feature for more granular cost attribution and analysis.\n\n### Warehouse-Based Cost Allocation\n\nWhen warehouses are dedicated to a specific business unit, cost allocation is straightforward. There are two common scenarios:\n\n**Scenario 1: Object Tagging** ( _recommended_ ) Warehouses are tagged using [object tagging](https://docs.snowflake.com/en/user-guide/object-tagging) to logically group cost centers. The cost attribution to a business unit for a given month can be computed using the following query. Note that this requires compliance, and a unique tag attributed to every warehouse. For reconciliation, the following example query also groups the untagged warehouses into the _untagged_ bucket.\n\n```\nSELECT COALESCE(tag_references.tag_value, 'untagged') AS tag_value,   \n       SUM(warehouse_metering_history.credits_used_compute) AS total_credits  \nFROM snowflake.account_usage.warehouse_metering_history  \nLEFT JOIN snowflake.account_usage.tag_references  \nON warehouse_metering_history.warehouse_id = tag_references.object_id  \nWHERE warehouse_metering_history.start_time >= DATE_TRUNC('MONTH', DATEADD(MONTH, -1, CURRENT_DATE))   \n  AND warehouse_metering_history.start_time < DATE_TRUNC('MONTH',  CURRENT_DATE)  \nGROUP BY COALESCE(tag_references.tag_value, 'untagged')  \nORDER BY total_credits DESC;\n```\n\nPress enter or click to view image in full size\n\n**Scenario 2: Warehouse Naming Convention** Warehouses follow a naming convention such as _teamname\\_details_ or _workload\\_details_ . This allows for direct mapping of costs to the respective business units or workloads. Here is an example query that gives a split of the costs across teams assuming they follow a naming convention. The _others_ bucket captures the ones not following the convention for reconciliation.\n\n```\nSELECT   \n    CASE   \n        WHEN POSITION('_' IN warehouse_metering_history.warehouse_name) > 0   \n             THEN SPLIT_PART(warehouse_metering_history.warehouse_name, '_', 1)  \n        ELSE 'others'  \n    END AS team_name,  \n    SUM(warehouse_metering_history.credits_used_compute) AS total_credits  \nFROM snowflake.account_usage.warehouse_metering_history  \nWHERE warehouse_metering_history.start_time >= DATE_TRUNC('MONTH', DATEADD(MONTH, -1, CURRENT_DATE))   \n  AND warehouse_metering_history.start_time < DATE_TRUNC('MONTH',  CURRENT_DATE)  \nGROUP BY team_name  \nORDER BY total_credits DESC;\n```\n\n### Introducing Per Query Cost Attribution\n\nWhen multiple business units or workloads share the same warehouse, cost allocation becomes more complex as the warehouse-level granularity is not sufficient enough. Even in cases where a warehouse may be tied to a given business unit, the unit may want to understand the costs in a more granular manner. The per query cost attribution [feature](https://docs.snowflake.com/LIMITEDACCESS/query_attribution_history) , now **generally available** , helps in these scenarios. This feature allows for warehouse cost attribution at the query level.\n\nThe per query cost attribution feature provides the portion of the warehouse cost that can be attributed to a given query. If there is only a single query running in a warehouse, the entire cost of the warehouse is attributed to that query. If multiple simultaneous queries are running, the cost of the warehouse during the overlapping periods is attributed to the queries based on their relative resource consumption. During the times when there is no query running and the warehouse is idle (not suspended), the costs are not attributed to any particular query but can be easily determined and spread across the queries as needed for reconciliation purposes.\n\n**Common Methods to Allocate Costs Using Per Query Cost Attribution**\n\n**1\\. User-Based Costs** Understanding costs associated with a given user can be useful for accountability, budgeting and more granular forecasting. It can also provide hints on which users are most effective in their use of Snowflake. Chargeback of Snowflake costs at a user level can be achieved using the USER\\_NAME column in the QUERY\\_ATTRIBUTION\\_HISTORY view. The following sample query provides a way to attribute monthly warehouse costs across users. The idle time costs are proportionately attributed based on the relative spend by users.\n\n```\nWITH wh_bill AS (  \n   SELECT SUM(credits_used_compute) AS compute_credits  \n   FROM snowflake.account_usage.warehouse_metering_history  \n   WHERE start_time >= DATE_TRUNC('MONTH', DATEADD(MONTH, -1, CURRENT_DATE))  \n   AND start_time < DATE_TRUNC('MONTH', CURRENT_DATE)  \n),  \nuser_credits AS (  \n   SELECT user_name, SUM(credits_attributed_compute) AS credits  \n   FROM snowflake.account_usage.query_attribution_history  \n   WHERE start_time >= DATE_TRUNC('MONTH', DATEADD(MONTH, -1, CURRENT_DATE))  \n   AND start_time < DATE_TRUNC('MONTH', CURRENT_DATE)  \n   GROUP BY user_name  \n),  \ntotal_credit AS (  \n   SELECT SUM(credits) AS sum_all_credits  \n   FROM user_credits  \n)  \nSELECT u.user_name, u.credits / t.sum_all_credits * w.compute_credits AS attributed_credits  \nFROM user_credits u, total_credit t, wh_bill w;\n```\n\nPress enter or click to view image in full size\n\nUsers can be mapped to business units / cost centers in a custom view, which can be used along with the user-based costs to roll up the spend across business units. Alternatively, the ROLE\\_NAME (available in QUERY\\_HISTORY view) can be used to allocate costs for a given project, if several developers use a given role for a specific project. This method does not require manual tagging, thereby reducing the operational overhead to enforce tagging policies.\n\n**2\\. Query Tag-Based Costs** [Query tags](https://docs.snowflake.com/en/sql-reference/parameters) can be used to allocate costs across different workloads. Customers can assign query tags to specific workloads or a set of queries to track them together. These can be set at a session level (Account->User->Session) and can also be configured when issuing snowflake queries from tools such as [dbt](https://docs.getdbt.com/reference/resource-configs/snowflake-configs) , [airflow](https://airflow.apache.org/docs/apache-airflow-providers-snowflake/stable/_api/airflow/providers/snowflake/hooks/snowflake_sql_api/index.html) , etc. The following example query helps attribute the warehouse compute costs from the previous month to different workloads, assuming that workloads are tagged, and also allocates the idle costs proportionately across workloads for reconciliation purposes.\n\n```\nWITH wh_bill AS (  \n   SELECT SUM(credits_used_compute) AS compute_credits  \n   FROM snowflake.account_usage.warehouse_metering_history  \n   WHERE start_time >= DATE_TRUNC('MONTH', DATEADD(MONTH, -1, CURRENT_DATE))  \n   AND start_time < DATE_TRUNC('MONTH', CURRENT_DATE)  \n),  \ntag_credits AS (  \n   SELECT COALESCE(NULLIF(query_tag, ''), 'untagged') AS tag, SUM(credits_attributed_compute) AS credits  \n   FROM snowflake.account_usage.query_attribution_history  \n   WHERE start_time >= DATE_TRUNC('MONTH', DATEADD(MONTH, -1, CURRENT_DATE))  \n   AND start_time < DATE_TRUNC('MONTH', CURRENT_DATE)  \n   GROUP BY tag  \n),  \ntotal_credit AS (  \n   SELECT SUM(credits) AS sum_all_credits  \n   FROM tag_credits  \n)  \nSELECT tc.tag, tc.credits / t.sum_all_credits * w.compute_credits AS attributed_credits  \nFROM tag_credits tc, total_credit t, wh_bill w;\n```\n\nPress enter or click to view image in full size\n\n**3\\. Recurrent Query Costs** For recurrent or similar queries, costs can be attributed using QUERY\\_HASH and QUERY\\_PARAMETERIZED\\_HASH. If there are several recurrent / similar queries and want to understand costs attributable to such queries over a period, you can use the following example query to group the costs based on the recurrent queries and identify the top drivers of cost for the past month (most expensive recurrent queries). Note that the attributed costs of a query changes depending on the environment (size of a warehouse, utilization of warehouse, other queries running during that time etc.).\n\n```\nSELECT query_parameterized_hash,   \n       COUNT(*) AS query_count,   \n       SUM(credits_attributed_compute) AS total_credits  \nFROM snowflake.account_usage.query_attribution_history  \nWHERE start_time >= DATE_TRUNC('MONTH', DATEADD(MONTH, -1, CURRENT_DATE))  \n  AND start_time < DATE_TRUNC('MONTH', CURRENT_DATE)  \nGROUP BY query_parameterized_hash  \nORDER BY total_credits DESC  \nLIMIT 20;\n```\n\nPress enter or click to view image in full size\n\nAdditionally, for stored procedures that often issue multiple hierarchical queries, you can compute the attributed costs for the entire procedure using the following example query, as the parent and the root query ids are available for such procedures in the view.\n\n```\nSET query_id = '<query_id>'; // root query id for the stored procedure  \n  \nSELECT SUM(credits_attributed_compute) AS total_attributed_credits  \n  FROM SNOWFLAKE.ACCOUNT_USAGE.QUERY_ATTRIBUTION_HISTORY  \n  WHERE (root_query_id = $query_id  \n         OR query_id = $query_id);\n```\n\n### Conclusion\n\nSnowflake\u2019s per query cost attribution feature, along with existing cost allocation mechanisms, provides powerful tools for granular cost management. By leveraging these features, organizations can enhance transparency, optimize resource usage, and ensure fair cost allocation. For more details, visit Snowflake\u2019s [per query cost attribution](https://docs.snowflake.com/LIMITEDACCESS/query_attribution_history) page.\n\nMaximize your cost efficiency with Snowflake and take control of your data platform expenses today!\n\nOptimization\n\nCost Management\n\nSnowflake\n\nWarehouse Management\n\n\\-- \n\n\\--\n\n[](https://medium.com/snowflake?source=post_page---post_publication_info--cf96fb690967---------------------------------------)\n\n[](https://medium.com/snowflake?source=post_page---post_publication_info--cf96fb690967---------------------------------------)\n\n[## Published in Snowflake Builders Blog: Data Engineers, App Developers, AI, & Data Science](https://medium.com/snowflake?source=post_page---post_publication_info--cf96fb690967---------------------------------------)\n\n11K followers\n\n\u00b7 Last published 9 hours ago\n\nBest practices, tips & tricks from Snowflake experts and community\n\n## Written by Kaushal Jain\n\n27 followers\n\n\u00b7 7 following\n\n## No responses yet\n\n[](https://policy.medium.com/medium-rules-30e5502c4eb4?source=post_page---post_responses--cf96fb690967---------------------------------------)"
      ],
      "full_content": null
    }
  ],
  "errors": [],
  "warnings": [
    {
      "type": "warning",
      "message": "Neither objective nor search_queries were provided, provide at least one to increase the relevance of excerpts.",
      "detail": null
    }
  ],
  "usage": [
    {
      "name": "sku_extract_excerpts",
      "count": 1
    }
  ]
}
